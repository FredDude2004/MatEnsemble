  Bootstrap: docker
  From: savannah.ornl.gov/olcf-container-images/cpe:25.03_gnu_ubuntu

  %post

      apt update
      apt install -y \
      autoconf \
      automake \
      libtool \
      make \
      pkg-config \
      libc6-dev \
      libzmq3-dev \
      uuid-dev \
      libjansson-dev \
      liblz4-dev \
      libarchive-dev \
      libhwloc-dev \
      libsqlite3-dev \
      lua5.1 \
      liblua5.1-dev \
      lua-posix \
      python3-dev \
      python3-cffi \
      python3-ply \
      python3-setuptools \
      python3-yaml \
      python3-sphinx \
      aspell \
      aspell-en \
      time \
      valgrind \
      libmpich-dev \
      jq \
      build-essential \
      ninja-build \
      cmake \
      pkg-config \
      libboost-all-dev \
      libboost-dev \
      libboost-graph-dev \
      python3-jsonschema \
      libyaml-cpp-dev \
      libedit-dev \
      curl \
      git

      export PREFIX=/opt/flux

      # Build flux-core
      cd /tmp
      wget https://github.com/flux-framework/flux-core/releases/download/v0.66.0/flux-core-0.66.0.tar.gz
      tar xzf flux-core-0.66.0.tar.gz
      cd flux-core-0.66.0

      ./configure --prefix="${PREFIX}"
      make
      make install

      export PATH="${PREFIX}/bin:${PATH}"
      export LD_LIBRARY_PATH="${PREFIX}/lib:${PREFIX}/lib64:${LD_LIBRARY_PATH:-}"
      export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PREFIX}/lib64/pkgconfig:${PKG_CONFIG_PATH:-}"

      # Build flux-sched
      cd /tmp
      wget https://github.com/flux-framework/flux-sched/releases/download/v0.36.1/flux-sched-0.36.1.tar.gz
      tar xzf flux-sched-0.36.1.tar.gz
      cd flux-sched-0.36.1

      cmake -S . -B build \
        -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
        -DCMAKE_PREFIX_PATH="${PREFIX}"
      cmake --build build
      cmake --build build -t install

      # install uv
      curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR=/usr/local/bin sh
      export PATH="/usr/local/bin:${PATH}"
      uv --version

      # build MatEnsemble
      cd /tmp
      git clone https://github.com/FredDude2004/MatEnsemble.git
      cd MatEnsemble

      uv venv /opt/venv
      export VIRTUAL_ENV=/opt/venv
      export PATH="$VIRTUAL_ENV/bin:$PATH"

      uv sync --all-extras --dev


  %environment
      export PREFIX=/opt/flux
      export VIRTUAL_ENV=/opt/venv
      export PATH="${PREFIX}/bin:${VIRTUAL_ENV}/bin:${PATH}"
      export LD_LIBRARY_PATH="${PREFIX}/lib:${PREFIX}/lib64:${LD_LIBRARY_PATH:-}"
      export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PREFIX}/lib64/pkgconfig:${PKG_CONFIG_PATH:-}"
      export PYTHONPATH="${PREFIX}/lib/flux/python3.12"

  %runscript
      # put a little echo message here that tells users how to use the image
