Bootstrap: docker
From: savannah.ornl.gov/olcf-container-images/cpe:25.03_gnu_ubuntu

%post
    set -euxo pipefail
    export DEBIAN_FRONTEND=noninteractive
    export PREFIX=/opt/flux

    apt update
    apt install -y \
        ca-certificates wget curl \
        build-essential pkg-config \
        python3 python3-pip python3-dev python3-venv \
        cmake \
        libhwloc-dev libboost-dev libboost-graph-dev libedit-dev libyaml-cpp-dev python3-yaml
    rm -rf /var/lib/apt/lists/*

    # Build flux-core 
    cd /tmp
    wget -q https://github.com/flux-framework/flux-core/releases/download/v0.81.0/flux-core-0.81.0.tar.gz
    tar xzf flux-core-0.81.0.tar.gz
    cd flux-core-0.81.0

    ./scripts/install-deps-deb.sh
    ./configure --prefix="${PREFIX}"
    make 
    make check 
    make install

    export PATH="${PREFIX}/bin:${PATH}"
    export LD_LIBRARY_PATH="${PREFIX}/lib:${PREFIX}/lib64:${LD_LIBRARY_PATH:-}"
    export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PREFIX}/lib64/pkgconfig:${PKG_CONFIG_PATH:-}"

    # Build flux-sched 
    cd /tmp
    wget -q https://github.com/flux-framework/flux-sched/releases/download/v0.48.0/flux-sched-0.48.0.tar.gz
    tar xzf flux-sched-0.48.0.tar.gz
    cd flux-sched-0.48.0

    cmake -S . -B build \
      -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
      -DCMAKE_PREFIX_PATH="${PREFIX}"
    cmake --build build 
    cmake --build build -t install
    ctest --test-dir build 

    # Python deps 
    python3 -m pip install -U pip setuptools wheel
    # Install matensemble with the optional flux-python package and deps from actual PyPI
    uv pip install -i https://test.pypi.org/simple --extra-index-url https://pypi.org/simple matensemble[flux]

    # checks 
    flux --version

    # Verify Python flux bindings 
    python3 -c "import flux, flux.job; print('flux python ok')"
    python3 -c "import matensemble; print('matensemble ok')"

%environment
    export PREFIX=/opt/flux
    export PATH="${PREFIX}/bin:${PATH}"
    export LD_LIBRARY_PATH="${PREFIX}/lib:${PREFIX}/lib64:${LD_LIBRARY_PATH:-}"
    export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PREFIX}/lib64/pkgconfig:${PKG_CONFIG_PATH:-}"

    # If python bindings land under the prefix, you may need this:
    # (harmless if path doesn't exist)
    for d in "${PREFIX}"/lib/python*/site-packages "${PREFIX}"/lib64/python*/site-packages; do
        if [ -d "$d" ]; then
            export PYTHONPATH="$d:${PYTHONPATH:-}"
        fi
    done

