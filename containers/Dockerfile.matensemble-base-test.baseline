# ------------------------------------------------------------------------------
# Build stage: compile Flux + Flux-sched + LAMMPS, and stage Python bindings into
# a stable, venv-independent directory: /opt/hpc-python
# ------------------------------------------------------------------------------
FROM python:3.12.12-slim-trixie AS builder
ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-c"]

ARG FLUX_CORE_VER=0.66.0
ARG FLUX_SCHED_VER=0.38.0
ARG LAMMPS_TAG=stable_2Aug2023_update3

ENV FLUX_PREFIX=/opt/flux
ENV LAMMPS_PREFIX=/opt/lammps
ENV HPC_PYTHONPATH=/opt/hpc-python

RUN apt-get update && apt-get install -y --no-install-recommends \
    autoconf  	   	automake 		libtool \
    make 	   	pkg-config 	      	libc6-dev \
    libzmq3-dev    	uuid-dev 	      	libjansson-dev \
    liblz4-dev 	   	libarchive-dev     	libhwloc-dev \
    libsqlite3-dev 	lua5.1 	      		liblua5.1-dev \
    lua-posix 	   	python3-dev 	      	python3-cffi \
    python3-ply    	python3-setuptools 	python3-yaml \
    python3-sphinx 	aspell 	      		aspell-en \
    time 	   	valgrind   	      	libmpich-dev jq \
    libhwloc-dev 	libboost-dev 		libboost-graph-dev \
    libedit-dev 	libyaml-cpp-dev 	python3-yaml \
    git	 	   	curl		      	build-essential \
    wget 		ninja-build		cmake \
    && rm -rf /var/lib/apt/lists/*

# Python build tools needed by LAMMPS install.py (wheel creation) and Flux checks
RUN python -m pip install --no-cache-dir -U pip setuptools wheel cffi PyYAML ply jsonschema

# ---- build flux-core ----------------------------------------------------------
RUN set -euo pipefail; \
    cd /tmp; \
    wget -O flux-core.tgz "https://github.com/flux-framework/flux-core/releases/download/v${FLUX_CORE_VER}/flux-core-${FLUX_CORE_VER}.tar.gz"; \
    tar xzf flux-core.tgz; \
    cd "flux-core-${FLUX_CORE_VER}"; \
    ./configure --prefix="${FLUX_PREFIX}" --disable-docs; \
    make -j"$(nproc)"; \
    make install; \
    rm -rf /tmp/flux-core.tgz "/tmp/flux-core-${FLUX_CORE_VER}"

# ---- build flux-sched ---------------------------------------------------------
RUN set -euo pipefail; \
    cd /tmp; \
    wget -O flux-sched.tgz "https://github.com/flux-framework/flux-sched/releases/download/v${FLUX_SCHED_VER}/flux-sched-${FLUX_SCHED_VER}.tar.gz"; \
    tar xzf flux-sched.tgz; \
    cd "flux-sched-${FLUX_SCHED_VER}"; \
    cmake -S . -B build \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX="${FLUX_PREFIX}" \
      -DCMAKE_PREFIX_PATH="${FLUX_PREFIX}" \
      -DENABLE_DOCS=Off; \
    cmake --build build -j"$(nproc)"; \
    cmake --install build; \
    rm -rf /tmp/flux-sched.tgz "/tmp/flux-sched-${FLUX_SCHED_VER}"

# ---- build lammps -------------------------------------------------------------
RUN set -euo pipefail; \
    cd /tmp; \
    wget -O lammps.tgz "https://github.com/lammps/lammps/archive/refs/tags/${LAMMPS_TAG}.tar.gz"; \
    tar xzf lammps.tgz; \
    SRC="/tmp/lammps-${LAMMPS_TAG}"; \
    mkdir -p /tmp/lammps_build; \
    cd /tmp/lammps_build; \
    cmake -D CMAKE_BUILD_TYPE=Release \
          -D CMAKE_INSTALL_PREFIX="${LAMMPS_PREFIX}" \
          -D BUILD_SHARED_LIBS=ON \
          -D BUILD_MPI=ON \
          -D PKG_PYTHON=ON \
          -D Python_EXECUTABLE="$(command -v python)" \
          -D Python3_EXECUTABLE="$(command -v python)" \
          "${SRC}/cmake"; \
    cmake --build . -j"$(nproc)"; \
    cmake --install .; \
    rm -rf /tmp/lammps_build

# ---- stage python bindings into /opt/hpc-python -------------------------------
RUN set -euo pipefail; \
    mkdir -p "${HPC_PYTHONPATH}"; \
    \
    # 1) Flux python bindings: copy whatever Flux says should be on PYTHONPATH
    flux_py="$("${FLUX_PREFIX}/bin/flux" env | sed -n 's/^export PYTHONPATH="\([^"]*\)".*/\1/p')"; \
    test -n "${flux_py}"; \
    IFS=':' read -ra parts <<< "${flux_py}"; \
    for p in "${parts[@]}"; do \
      if [[ -d "$p" ]]; then \
        cp -a "$p"/. "${HPC_PYTHONPATH}/"; \
      fi; \
    done; \
    \
    # 2) LAMMPS python bindings: build a wheel, then install it into /opt/hpc-python
    SRC="/tmp/lammps-${LAMMPS_TAG}"; \
    mkdir -p /tmp/lammps_wheels; \
    python "${SRC}/python/install.py" \
        -p "${SRC}/python/lammps" \
        -l "${LAMMPS_PREFIX}/lib/liblammps.so" \
        -v "${SRC}/src/version.h" \
        -n \
        -w /tmp/lammps_wheels; \
    python -m pip install --no-cache-dir --no-deps --target "${HPC_PYTHONPATH}" /tmp/lammps_wheels/*.whl; \
    \
    rm -rf /tmp/lammps_wheels "${SRC}" /tmp/lammps.tgz

# quick sanity test in build stage
RUN set -euo pipefail; \
    PYTHONPATH="${HPC_PYTHONPATH}" python -c "import flux, lammps; print('builder-ok')"; \
    "${FLUX_PREFIX}/bin/flux" --version

# ------------------------------------------------------------------------------
# Runtime stage: only runtime libs + /opt/flux + /opt/lammps + /opt/hpc-python
# ------------------------------------------------------------------------------
FROM python:3.12.12-slim-trixie
ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-c"]

# install run-time dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates 		libzmq5 			libuuid1 \
    libjansson4 		liblz4-1 			libarchive13 \
    libhwloc15 		  	libsqlite3-0 			lua5.1 \
    lua-posix 		  	libyaml-cpp0.8 			libedit2 \
    mpich 		  	libboost-graph1.83.0 		libboost-system1.83.0 \
    libboost-thread1.83.0 	libboost-filesystem1.83.0 	libboost-program-options1.83.0 \
    libboost-regex1.83.0 	libboost-serialization1.83.0 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /opt/flux /opt/flux
COPY --from=builder /opt/lammps /opt/lammps
COPY --from=builder /opt/hpc-python /opt/hpc-python

ENV FLUX_PREFIX=/opt/flux
ENV LAMMPS_PREFIX=/opt/lammps
ENV PYTHONPATH=/opt/hpc-python
ENV PATH="/opt/flux/bin:/opt/lammps/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/flux/lib:/opt/flux/lib64:/opt/lammps/lib:/opt/lammps/lib64"
ENV LAMMPS_LIBRARY="/opt/lammps/lib/liblammps.so"

RUN set -euo pipefail; \
    python -c "import flux, lammps; print('runtime-ok')"; \
    flux --version

